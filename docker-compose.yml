###############################################################################
# KeyCortex — Docker Compose
#
# Services:
#   wallet-service   Rust API server (port 8080)
#   postgres         PostgreSQL 16 (optional, port 5432)
#   ui-js            JS baseline frontend via nginx (port 8090)
#   ui-wasm          WASM frontend via nginx (port 8091)
#   watchdog         Transactional flow monitor
#
# Usage:
#   docker compose up -d                          # Core services (API + UIs)
#   docker compose --profile postgres up -d       # With PostgreSQL
#   docker compose --profile full up -d           # Everything incl. watchdog
#   docker compose logs -f wallet-service         # Follow API logs
#   docker compose down                           # Stop all
###############################################################################

services:
  # ── Wallet Service API ────────────────────────────────────────────────────
  wallet-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: keycortex-api
    ports:
      - "8080:8080"
    volumes:
      - keycortex-data:/app/data
    environment:
      - RUST_LOG=info
      - KEYCORTEX_KEYSTORE_PATH=/app/data/keystore/rocksdb
      - AUTHBUDDY_JWT_SECRET=${AUTHBUDDY_JWT_SECRET:-dev-secret-change-me}
      - DATABASE_URL=${DATABASE_URL:-}
      - KEYCORTEX_POSTGRES_MIGRATIONS_DIR=/app/migrations/postgres
    depends_on:
      postgres:
        condition: service_healthy
        required: false
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/readyz"]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 3

  # ── PostgreSQL ────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: keycortex-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: keycortex
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-keycortex}
      POSTGRES_DB: keycortex
    volumes:
      - pg-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycortex"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    profiles:
      - postgres
      - full

  # ── JS Baseline Frontend ─────────────────────────────────────────────────
  ui-js:
    image: nginx:alpine
    container_name: keycortex-ui-js
    ports:
      - "8090:80"
    volumes:
      - ./ui/wallet-baseline:/usr/share/nginx/html:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/index.html"]
      interval: 15s
      timeout: 3s
      retries: 2

  # ── WASM Frontend ────────────────────────────────────────────────────────
  # Mounts entire ui/ tree so ../wallet-baseline/ relative paths resolve.
  # nginx-wasm.conf sets root to /usr/share/nginx/html/wallet-wasm.
  ui-wasm:
    image: nginx:alpine
    container_name: keycortex-ui-wasm
    ports:
      - "8091:80"
    volumes:
      - ./ui:/usr/share/nginx/html:ro
      - ./config:/usr/share/nginx/config:ro
      - ./ui/wallet-wasm/assets:/usr/share/nginx/assets:ro
      - ./deploy/nginx-wasm.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/index.html"]
      interval: 15s
      timeout: 3s
      retries: 2

  # ── Watchdog ──────────────────────────────────────────────────────────────
  watchdog:
    build:
      context: .
      dockerfile: Dockerfile.watchdog
    container_name: keycortex-watchdog
    environment:
      - KEYCORTEX_API_URL=http://wallet-service:8080
      - KEYCORTEX_JS_URL=http://ui-js:80
      - KEYCORTEX_WASM_URL=http://ui-wasm:80
      - WATCHDOG_INTERVAL=${WATCHDOG_INTERVAL:-60}
      - GIT_USER_NAME=${GIT_USER_NAME:-KeyCortex Watchdog}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-watchdog@keycortex.local}
    volumes:
      - watchdog-data:/app/.watchdog
      - ${SSH_AUTH_SOCK:-/dev/null}:/ssh-agent:ro
    depends_on:
      wallet-service:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - watchdog
      - full

volumes:
  keycortex-data:
    driver: local
  pg-data:
    driver: local
  watchdog-data:
    driver: local
